<!DOCTYPE html>
<html lang="en" >
<head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="index.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script>
        var jsonArray, RA;
        window.onload = function(){
            console.log("sending post to server");
            var json={};
            xmlRequest = new XMLHttpRequest();
            xmlRequest.open("POST", "/Plant_Operator/index", true);
            xmlRequest.setRequestHeader('Content-type', 'application/json');
            xmlRequest.send();
            xmlRequest.onreadystatechange = function(){
                if((xmlRequest.readyState == 4 ) && (xmlRequest.status == 200)){
                    console.log("Got response : ");
                    console.log(xmlRequest.responseText);
                    jsonArray = JSON.parse(xmlRequest.responseText);
                    tablePart = JSON.parse(xmlRequest.responseText);
                    for(var i=0;i<tablePart.length;i++)
                    {
                        var json = tablePart[i];
                        $("#tablePart").append("" +
                            "<tr onclick='clickPart("+i+")'>" +
                            "<td>"+json.PartName+"</td>" +
                            "<td>"+json.Location+"</td>" +
                            "<td>"+json.PartDescription+"</td>" +
                            "<td>"+json.SupplierName+"</td>" +
                            "</tr>");
                    }
                }
            };
            xmlRequest2 = new XMLHttpRequest();
            xmlRequest2.open("POST", "/Plant_Operator/GetRALevel", true);
            xmlRequest2.setRequestHeader('Content-type', 'application/json');
            xmlRequest2.send();
            xmlRequest.onreadystatechange = function() {
                if ((xmlRequest.readyState == 4) && (xmlRequest.status == 200)) {
                    RA = JSON.parse(xmlRequest.responseText);
                    for(var i=0;i<RA.length;i++)
                    {
                        var json = RA[i];
                        $("#ReductionAgent").append("<center>"+
                        "<canvas class=\"center-block\" id=\"myCanvas\""+json.IdReductionAgent+" width=\"235\" height=\"150\"></canvas>"+
                        "</center>");
                        var percentage = Math.floor((json.LevelOfRAInL*100)/json.TotalCapacityInL);
                        $("#AddCanvas").append(canvas(percentage,json));
                    }
                }
            };
        };
        
        function Logout(){
				document.getElementById("Logout").submit();
		}
        function searchPart(value)
        {
            document.getElementById("tablePart").innerHTML = "";
            AddToTable(tablePart, "tablePart", value);
        }

        function AddToTable(jsonArray, IdTable, SearchedKeyWord){
            console.log("Adding to table : " + IdTable);
            console.log(jsonArray);
            for(var i=0;i<jsonArray.length;i++){
                var json = jsonArray[i];
                if(json.PartName.includes(SearchedKeyWord) || json.Location.includes(SearchedKeyWord) || json.SupplierName.includes(SearchedKeyWord)){
                    $("#" + IdTable).append(""+
                        "<tr onclick='clickPart("+i+")'>"+
                        "<td>"+json.PartName+"</td>"+
                        "<td>"+json.Location+"</td>"+
                        "<td>"+json.PartDescription+"</td>"+
                        "<td>"+json.SupplierName+"</td>"+
                        "</tr>");
                }
            }
        }
    </script>
    <title>Plant Operator</title>
</head>
<body>
<header id="navbar">
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <div class="navbar-brand">
                    <p>Identifier</p>
                </div>
            </div>
            <ul class="nav navbar-nav">
                <li class="active"><a href="index.html">Home</a></li>
                <li><a href="History.html">History</a></li>
                <li><a href="Contact.html">Contact</a></li>
                <li><a href="Offer.html">Offers</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><img width="41%" src="../Picture/ERC_Logo.png"></li>
                <li onclick="Logout()"><a href="#"><span class="glyphicon glyphicon-log-in"></span> Logout</a></li>
				<form method="POST" id="Logout" action="/Logout"></form>
            </ul>

        </div>
    </nav>
</header>
<div id="PartTable" class="col-1">
<table class="table table-striped border-0">
    <thead>
    <tr>
        <th id="PartName">Part Name</th>
        <th id="PartDescription">Part Location</th>
        <th id="PartLocation">Part Description</th>
        <th id="SupplierName">Supplier Name</th>
    </tr>
    </thead>
    <tbody id="tablePart">
    </tbody>
</table>
</div>
<div id="Right">
    <div id="SearchBar">
            <input type="text" class="form-control" id="search" placeholder="Search" onkeyup="searchPart(this.value)">
    </div>
    <div id="ReductionAgent">
        <center><h3 id="TitleRa">Reduction Agent</h3></center>
        <center>
        <canvas class="center-block" id="myCanvas" width="235" height="150"></canvas>
        </center>
    </div>
            <div id="Button"><center>
           <span class="btn btn-primary btn-just-icon btn-sm btn-file" rel="tooltip">
             <i class="material-icons" >monetization_on</i><input type="file" id="file">
        </span>
            <a id="ContactButton" class="btn btn-info" href="#" role="button"><i class="material-icons" >contact_support</i></a>
            </center></div>

</div>
</body>
<script id="AddCanvas">

function LevelRa(percentage)
{
    return percentage*($("#myCanvas").width()-36)/100;
}

function canvas(percentage,array)
{
    var c =document.getElementById(array.IdReductionAgent);
    var ctx = c.getContext("2d");
    var grd = ctx.createLinearGradient(0,0,200,0);
    grd.addColorStop(0,"red");
    grd.addColorStop(1,"blue");
    ctx.fillStyle = grd;
    ctx.strokeRect(0,25,200,100);
    var RaLevel = LevelRa(percentage);
    ctx.fillRect(0,25,RaLevel,100);
    ctx.font = "15px Helvetica";
    ctx.fillText(percentage+"%",RaLevel+5,75);
    ctx.fillText("0",0,145);
    ctx.fillText(array.TotalCapacityInL+" L",185,145);
    ctx.font = "20px Helvetica";
    ctx.fillStyle = "black";
    ctx.fillText(array.IdReductionAgent,(($("#myCanvas").width()-36)/2),20);
}

function clickPart(IdJson)
{
    xmlRequest = new XMLHttpRequest();
    xmlRequest.open("POST", "/Plant_Operator/PartDescription", true);
    xmlRequest.setRequestHeader('Content-type', 'application/json');
    xmlRequest.send(jsonArray[IdJson]);
    sessionStorage.setItem("SelectedPart", JSON.stringify(jsonArray[IdJson]));
    window.location.replace("/Plant_Operator/PartDescription.html");
}
</script>
</html>